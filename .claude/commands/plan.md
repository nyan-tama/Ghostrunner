# /plan

**ultrathink**

指定された仕様書を分析し、実装前に懸念点と実装内容を整理して提示してください。
ユーザーの確認を得てから実装に進みます。

## 実行方法

仕様書の内容に応じて適切な planner エージェントを使用する：

- **Go バックエンド** の実装計画 → `go-planner` エージェント
- **Next.js フロントエンド** の実装計画 → `nextjs-planner` エージェント
- **フルスタック（両方）** の実装計画 → 両方のエージェントを並行して実行し、1つの計画ファイルにまとめる

仕様書からどちらの実装が必要か判断できない場合は、ユーザーに確認する。

## 出力ルール

### 出力先

実装計画は以下のファイルに出力する：
- パス: `開発/実装/実装待ち/YYYY-MM-DD_機能名_plan.md`
- 例: `開発/実装/実装待ち/2026-01-23_列位置動的対応_plan.md`
- **機能名は日本語にすること。**

**既存の仕様書がある場合:**
- 仕様書が既に `開発/実装/実装待ち/` にある場合は、そのファイルに計画セクションを追記する

### 図示ルール

- 図示が必要な場合は **Mermaid** を使用する
- ASCII図（罫線文字やスペースで描く図）は **禁止**

## 分析フェーズ

### 1. 仕様書の理解

- 仕様書を読み込み、実装する機能の全体像を把握する
- 関連する既存コードを調査し、現状を理解する
- 既存ドキュメントを参照して現状のアーキテクチャを把握する
  - バックエンド: `backend/docs/` 配下（`BACKEND_API.md`, `BACKEND_CONTRIB.md`, `BACKEND_RUNBOOK.md`）
  - バックエンド: 各パッケージの `doc.go`（`backend/internal/*/doc.go`）
  - フロントエンド: `frontend/docs/` 配下（`screens.md`, `screen-flow.md`, `scenarios/`）

### 2. 懸念点の洗い出し

以下の観点で懸念点を整理する：

- **仕様の曖昧さ**: 不明確な点、複数解釈が可能な点
- **技術的課題**: 実装上の難しい点、パフォーマンス懸念
- **既存コードとの整合性**: 既存パターンとの矛盾、影響範囲
- **エッジケース**: 考慮すべき特殊ケース

**懸念点の解消:**
- 懸念点ごとにシンプルな解決策の選択肢（2〜3案）を提示する
- ユーザーの判断を得てから実装に進む
- 選択結果を計画ファイルに記録する

### 3. 実装内容の整理

各 planner エージェントの出力フォーマットに従って整理する。

**重要: コードロジックは書かない**
- 計画書には「何を追加/修正するか」のみを記述
- 「どう実装するか」（ロジック、アルゴリズム）は書かない
- 関数名、型名、フィールド名は記載するが、その中身は実装エージェントが考える

**フルスタック時の計画ファイル構成:**
```markdown
# 機能名 実装計画

## バックエンド計画
（go-planner の出力）

## フロントエンド計画
（nextjs-planner の出力）
```

## レビューフェーズ

### 4. 計画書の技術レビュー

専用レビューエージェントで技術的懸念を検証する。

**レビューエージェントの選択:**
- **Go バックエンド** の計画 → `go-plan-reviewer` エージェント
- **Next.js フロントエンド** の計画 → `nextjs-plan-reviewer` エージェント
- **フルスタック** の計画 → 両方のエージェントを並行して実行

**レビュー観点:**
- API設計: 型の整合性、エラーレスポンス形式、エンドポイントの責務
- データ構造: 型の重複、命名規則の統一
- 実装配置: 定数の配置、バリデーションの配置場所
- 既存コードとの整合性: パターンの一貫性、命名規則
- 仕様の明確性: 曖昧な表現、エッジケースの扱い

**レビュー結果の対応:**
- Critical（計画修正が必要）: 計画を修正し、再度レビューエージェントを実行
- Warning（検討推奨）: ユーザーに確認し、必要に応じて計画を修正
- 問題なし: 次のステップへ進む

**サイクルの終了条件:**
- レビューで Critical/Warning が 0 件になる
- または、ユーザーが「このまま進める」と判断

### 4.5. テストプラン作成（レビュー完了後）

技術レビューで修正点がなくなった**確定済みの計画**に対して、`test-planner` エージェントでテストプランを作成する。

- 確定済みの計画書を入力として渡す
- 変更内容のリスク分析に基づき、テストケースをカスタマイズ
- 過剰テスト（コスト増）と不足テスト（品質低下）の両方を防ぐ
- test-planner の出力を受け取り、計画ファイルの末尾に「テストプラン」セクションとして追記する

**テストプランの活用:**
- テストエージェント（`go-tester`, `nextjs-tester`）がレビュー後にテストコードを作成・実行する際の指針
- レビューエージェント（`go-reviewer`, `nextjs-reviewer`）がテスト充足性を判断する基準

### 5. セルフチェック

レビューエージェントの検証に加え、以下もチェックする：

- **重複チェック**: 同じ内容が複数箇所に記載されていないか
- **用語統一**: 列名、変数名、フィールド名が一貫しているか
- **整合性**: バックエンドとフロントエンドの型定義・フィールド名が一致しているか
- **網羅性**: 変更ファイル一覧に漏れがないか（モデル、型定義、リポジトリなど）
- **順序**: 実装ステップが依存関係を考慮した順序になっているか

問題を発見した場合は計画ファイルを修正し、修正内容を報告する。

## 確認フェーズ

### 6. ユーザーへの確認

- レビュー済みの計画を提示
- 不明点があれば質問
- 実装方針の承認を得る

### 7. 計画ファイルのコミット（必須）

**重要: このステップを絶対にスキップしないこと**

計画ファイル作成後、以下のコマンドを実行してコミットする:

```bash
git add "開発/実装/実装待ち/"
git commit -m "docs: add implementation plan for <機能名>"
git push
```

### 8. 実装への移行

承認後、以下のコマンドで実装を開始：
- 両方（フルスタック）: `/fullstack`
- Go バックエンドのみ: `/go`
- Next.js フロントエンドのみ: `/nextjs`

## タスク

$ARGUMENTS
