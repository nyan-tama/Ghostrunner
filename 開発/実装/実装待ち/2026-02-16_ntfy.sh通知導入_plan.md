# ntfy.sh 通知導入 - 実装計画

## 背景

- macOSのブラウザ通知（Web Notifications API）が動作しなくなった
- ブラウザの権限管理が厳しく、不安定
- スマホ（iOS/Android）でも通知を受けたい

## 方針

バックエンドからntfy.shにHTTP POSTする方式に移行。ブラウザの権限に依存せずmacOS + スマホで通知を受け取れるようにする。

---

## 変更ファイル一覧

| ファイル | 操作 | 概要 |
|----------|------|------|
| `backend/internal/service/ntfy.go` | 新規 | NtfyServiceインターフェースと実装 |
| `backend/internal/service/claude.go` | 変更 | NtfyService注入、complete/error時に通知呼び出し |
| `backend/cmd/server/main.go` | 変更 | NtfyService初期化とClaudeServiceへの注入 |
| `frontend/src/hooks/useDesktopNotification.ts` | 削除 | ブラウザ通知フック全体 |
| `frontend/src/app/page.tsx` | 変更 | desktopNotify関連コードの削除 |
| `backend/internal/service/ntfy_test.go` | 新規 | NtfyServiceのテスト |

---

## Step 1: NtfyService 作成 (`backend/internal/service/ntfy.go`)

OpenAIService (`openai.go`) と同じパターンで新規ファイルを作成:

- `NtfyService` インターフェース: `Notify(title, message string)`, `NotifyError(title, message string)`
- `ntfyServiceImpl` 構造体: `topicURL string`, `httpClient *http.Client`
- `NewNtfyService()`: 環境変数 `NTFY_TOPIC` を読み取り、未設定時は `nil` を返す
- `Notify()` / `NotifyError()`: goroutineで非同期HTTP POST（fire-and-forget）
- `send()`: ntfy.shへのPOST実行。Title/Priority/Tagsヘッダーを設定

## Step 2: ClaudeService に NtfyService を注入 (`backend/internal/service/claude.go`)

**構造体変更** (line 36-38):
- `claudeServiceImpl` に `ntfyService NtfyService` フィールドを追加

**コンストラクタ変更** (line 41-45):
- `NewClaudeService(ntfyService NtfyService)` にシグネチャ変更

**complete通知追加** (line 188-190):
- `finalResult` 設定直後に `s.notifyComplete(event.Result.Output)` を呼び出し

**フォールバックcomplete通知追加** (line 264-274):
- `finalResult == nil` のフォールバック完了時にも `s.notifyComplete("")` を呼び出し

**error通知追加** (5箇所、クライアント切断は除外):
- line 144: stdout pipe作成失敗
- line 153: コマンド開始失敗
- line 224: スキャナー読取エラー
- line 237: タイムアウト
- line 258: 一般的なコマンド失敗

**ヘルパーメソッド追加**:
- `notifyComplete(output string)`: nilガード付きで `s.ntfyService.Notify()` を呼ぶ
- `notifyError(message string)`: nilガード付きで `s.ntfyService.NotifyError()` を呼ぶ

## Step 3: main.go で依存注入 (`backend/cmd/server/main.go`)

```go
ntfyService := service.NewNtfyService()
claudeService := service.NewClaudeService(ntfyService)
```

## Step 4: フロントエンド通知コード削除

**`useDesktopNotification.ts`**: ファイル削除

**`page.tsx`** (6箇所):
- import文削除
- `useDesktopNotification()` 呼び出し削除
- `desktopNotify("コマンド完了", ...)` 削除
- dependency arrayから `desktopNotify` 削除
- `desktopNotify("コマンドエラー", ...)` 削除
- dependency arrayから `desktopNotify` 削除

## Step 5: テスト (`backend/internal/service/ntfy_test.go`)

`httptest.NewServer` でモックサーバーを立ててテスト:
- 環境変数設定時/未設定時のNewNtfyService動作
- POSTリクエストのヘッダー（Title, Priority, Tags）検証
- メッセージ100文字切り詰め検証

---

## 環境変数

| 変数名 | 説明 | 例 | 必須 |
|--------|------|-----|------|
| `NTFY_TOPIC` | ntfy.shトピック名 | `ghostrunner-a8f3k2x9` | No（未設定時は通知無効） |

## 受信側セットアップ

### スマホ（iOS / Android）
1. ntfyアプリをインストール（App Store / Google Play）
2. トピック名を入力して「Subscribe」

### macOS
1. `brew install ntfy` でCLIをインストール
2. `ntfy subscribe <topic>` で受信開始
3. macOSネイティブ通知として表示

## トピック名のセキュリティ

- 公式サーバーではトピック名 = パスワード
- 十分にランダムな文字列を使用（例: `ghostrunner-notify-a8f3k2x9`）
- 環境変数で管理、コードにハードコードしない

## 無料プランの制限

| 項目 | 制限 |
|------|------|
| 日次メッセージ | 250 |
| バースト制限 | 60リクエスト |

コマンド完了通知の用途なら十分。

## 検証手順

1. `cd backend && go build ./...` でビルド確認
2. `cd backend && go test ./internal/service/...` でテスト実行
3. `NTFY_TOPIC=test-topic make restart-backend-logs` でバックエンド起動
4. フロントエンドからコマンド実行し、ntfy.shに通知が届くことを確認
5. `cd frontend && npm run build` でフロントエンドビルド確認
