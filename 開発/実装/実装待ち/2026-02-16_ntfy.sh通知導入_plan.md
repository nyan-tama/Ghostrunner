# ntfy.sh 通知導入 - 実装計画

## 背景

- macOSのブラウザ通知（Web Notifications API）が動作しなくなった
- ブラウザの権限管理が厳しく、不安定
- スマホ（iOS/Android）でも通知を受けたい

## 方針

バックエンドからntfy.shにHTTP POSTする方式に移行。ブラウザの権限に依存せずmacOS + スマホで通知を受け取れるようにする。

---

## 変更ファイル一覧

| ファイル | 操作 | 概要 |
|----------|------|------|
| `backend/internal/service/ntfy.go` | 新規 | NtfyServiceインターフェースと実装 |
| `backend/internal/service/claude.go` | 変更 | NtfyService注入、complete/error時に通知呼び出し |
| `backend/cmd/server/main.go` | 変更 | NtfyService初期化とClaudeServiceへの注入 |
| `frontend/src/hooks/useDesktopNotification.ts` | 削除 | ブラウザ通知フック全体 |
| `frontend/src/app/page.tsx` | 変更 | desktopNotify関連コードの削除 |
| `backend/internal/service/ntfy_test.go` | 新規 | NtfyServiceのテスト |

---

## Step 1: NtfyService 作成 (`backend/internal/service/ntfy.go`)

OpenAIService (`openai.go`) と同じパターンで新規ファイルを作成:

- `NtfyService` インターフェース: `Notify(title, message string)`, `NotifyError(title, message string)`
- `ntfyServiceImpl` 構造体: `topicURL string`, `httpClient *http.Client`
- `NewNtfyService()`: 環境変数 `NTFY_TOPIC` を読み取り、未設定時は `nil` を返す
- `Notify()` / `NotifyError()`: goroutineで非同期HTTP POST（fire-and-forget）
- `send()`: ntfy.shへのPOST実行。Title/Priority/Tagsヘッダーを設定

## Step 2: ClaudeService に NtfyService を注入 (`backend/internal/service/claude.go`)

**構造体変更** (line 36-38):
- `claudeServiceImpl` に `ntfyService NtfyService` フィールドを追加

**コンストラクタ変更** (line 41-45):
- `NewClaudeService(ntfyService NtfyService)` にシグネチャ変更

**complete通知追加** (line 188-190):
- `finalResult` 設定直後に `s.notifyComplete(event.Result.Output)` を呼び出し

**フォールバックcomplete通知追加** (line 264-274):
- `finalResult == nil` のフォールバック完了時にも `s.notifyComplete("")` を呼び出し

**error通知追加** (5箇所、クライアント切断は除外):
- line 144: stdout pipe作成失敗
- line 153: コマンド開始失敗
- line 224: スキャナー読取エラー
- line 237: タイムアウト
- line 258: 一般的なコマンド失敗

**ヘルパーメソッド追加**:
- `notifyComplete(output string)`: nilガード付きで `s.ntfyService.Notify()` を呼ぶ
- `notifyError(message string)`: nilガード付きで `s.ntfyService.NotifyError()` を呼ぶ

## Step 3: main.go で依存注入 (`backend/cmd/server/main.go`)

```go
ntfyService := service.NewNtfyService()
claudeService := service.NewClaudeService(ntfyService)
```

## Step 4: フロントエンド通知コード削除

**`useDesktopNotification.ts`**: ファイル削除

**`page.tsx`** (6箇所):
- import文削除
- `useDesktopNotification()` 呼び出し削除
- `desktopNotify("コマンド完了", ...)` 削除
- dependency arrayから `desktopNotify` 削除
- `desktopNotify("コマンドエラー", ...)` 削除
- dependency arrayから `desktopNotify` 削除

## Step 5: テスト (`backend/internal/service/ntfy_test.go`)

`httptest.NewServer` でモックサーバーを立ててテスト:
- 環境変数設定時/未設定時のNewNtfyService動作
- POSTリクエストのヘッダー（Title, Priority, Tags）検証
- メッセージ100文字切り詰め検証

---

## 環境変数

| 変数名 | 説明 | 例 | 必須 |
|--------|------|-----|------|
| `NTFY_TOPIC` | ntfy.shトピック名 | `ghostrunner-a8f3k2x9` | No（未設定時は通知無効） |

## 受信側セットアップ

### スマホ（iOS / Android）
1. ntfyアプリをインストール（App Store / Google Play）
2. トピック名を入力して「Subscribe」

### macOS
1. `brew install ntfy` でCLIをインストール
2. `ntfy subscribe <topic>` で受信開始
3. macOSネイティブ通知として表示

## トピック名のセキュリティ

- 公式サーバーではトピック名 = パスワード
- 十分にランダムな文字列を使用（例: `ghostrunner-notify-a8f3k2x9`）
- 環境変数で管理、コードにハードコードしない

## 無料プランの制限

| 項目 | 制限 |
|------|------|
| 日次メッセージ | 250 |
| バースト制限 | 60リクエスト |

コマンド完了通知の用途なら十分。

## 検証手順

1. `cd backend && go build ./...` でビルド確認
2. `cd backend && go test ./internal/service/...` でテスト実行
3. `NTFY_TOPIC=test-topic make restart-backend-logs` でバックエンド起動
4. フロントエンドからコマンド実行し、ntfy.shに通知が届くことを確認
5. `cd frontend && npm run build` でフロントエンドビルド確認

---

## バックエンド実装レポート

### 実装サマリー
- **実装日**: 2026-02-16
- **対象フェーズ**: Step 1, 2, 3, 5（バックエンド側のみ。Step 4 フロントエンドは後続）
- **変更ファイル数**: 5 files

### 変更ファイル一覧

| ファイル | 操作 | 変更内容 |
|---------|------|---------|
| `backend/internal/service/ntfy.go` | 新規 | `NtfyService` インターフェース（`Notify`, `NotifyError`）と `ntfyServiceImpl` 構造体。環境変数 `NTFY_TOPIC` から `https://ntfy.sh/<topic>` を初期化、未設定時は `nil` 返却。`Notify` / `NotifyError` は goroutine で `send()` を非同期呼び出し（fire-and-forget）。`send()` で HTTP POST、Title/Priority/Tags ヘッダー設定、`io.Discard` によるレスポンスボディ破棄処理 |
| `backend/internal/service/claude.go` | 変更 | `claudeServiceImpl` に `ntfyService NtfyService` フィールド追加。`NewClaudeService(ntfyService NtfyService)` にシグネチャ変更。ストリームモード（`executeCommandStream`）: complete 通知 2 箇所、error 通知 5 箇所。非ストリームモード（`executeCommand`）: complete 通知 3 箇所、error 通知 2 箇所。ヘルパーメソッド `notifyComplete` / `notifyError` を追加（nil ガード付き） |
| `backend/cmd/server/main.go` | 変更 | `service.NewNtfyService()` の初期化と `service.NewClaudeService(ntfyService)` への依存注入を追加 |
| `backend/internal/service/ntfy_test.go` | 新規 | `TestNewNtfyService`: 環境変数テスト（テーブル駆動 2 ケース）。`TestNtfyService_Send`: `httptest.NewServer` モックサーバーでヘッダー/本文検証（4 ケース）。`TestNotifyComplete_MessageTruncation`: mockNtfyService でメッセージ 100 文字切り詰め検証（4 ケース）。計 10 テスト |
| `backend/internal/handler/doc.go` | 変更 | 使用例セクションの `NewClaudeService` 呼び出しを `ntfyService` 引数付きシグネチャに更新 |

### 計画からの変更点

実装計画に記載がなかった判断・選択：

- **非ストリームモード（`executeCommand`）にも通知を追加**: 計画書の Step 2 ではストリームモード（`executeCommandStream`）の通知箇所のみ記載されていたが、実装では `executeCommand` 側にも完了通知 3 箇所（正常パース成功時、エラー状態でもパース成功時、`result.Completed` 判定後）、エラー通知 2 箇所（タイムアウト、コマンド失敗）を追加した。これにより非ストリーム API 経由のコマンド実行でも通知が届く
- **`send()` でレスポンスボディを `io.Discard` に読み捨て**: ntfy.sh のレスポンスボディを明示的に破棄してからクローズする処理を追加。HTTP keep-alive の接続再利用を適切に行うための対応
- **`handler/doc.go` の使用例更新**: 計画書に記載はなかったが、`NewClaudeService` のシグネチャ変更に伴い、パッケージドキュメントの使用例コードも `ntfyService` 引数付きに更新

### レビュー結果

| 種別 | 指摘内容 | 対応 |
|------|---------|------|
| Critical | `handler/doc.go` の使用例が旧シグネチャ `NewClaudeService()` のまま、ビルドには影響しないがドキュメント不整合 | `ntfyService` 引数付きに修正済み |
| Suggestion | トピック名のログ出力マスク検討（セキュリティ） | 見送り: 開発環境のみの利用で、トピック名はログで確認できた方が運用上便利 |
| Suggestion | テストの goroutine 待機をチャネル待機パターンに変更 | 見送り: 現在のポーリング方式で十分動作しており、テスト全件 PASS |

### テスト結果

**全 10 テスト PASS**

```
=== RUN   TestNewNtfyService
=== RUN   TestNewNtfyService/NTFY_TOPIC未設定時はnilを返す
=== RUN   TestNewNtfyService/NTFY_TOPIC設定時は非nilを返す
--- PASS: TestNewNtfyService

=== RUN   TestNtfyService_Send
=== RUN   TestNtfyService_Send/Notify_リクエストヘッダーにdefault優先度とwhite_check_markタグが設定される
=== RUN   TestNtfyService_Send/NotifyError_リクエストヘッダーにhigh優先度とxタグが設定される
=== RUN   TestNtfyService_Send/Notify_メッセージ本文がPOSTボディに含まれる
=== RUN   TestNtfyService_Send/NotifyError_メッセージ本文がPOSTボディに含まれる
--- PASS: TestNtfyService_Send

=== RUN   TestNotifyComplete_MessageTruncation
=== RUN   TestNotifyComplete_MessageTruncation/空文字の場合はデフォルトメッセージが使われる
=== RUN   TestNotifyComplete_MessageTruncation/100文字以下の場合はそのまま渡される
=== RUN   TestNotifyComplete_MessageTruncation/ちょうど100文字の場合はそのまま渡される
=== RUN   TestNotifyComplete_MessageTruncation/100文字を超える場合は100文字に切り詰められて省略記号が付く
--- PASS: TestNotifyComplete_MessageTruncation
```

テスト内訳:
- `TestNewNtfyService`: 環境変数設定/未設定時の nil 判定（テーブル駆動 2 ケース）
- `TestNtfyService_Send`: HTTP モックサーバーで Method/Title/Priority/Tags/Body 検証（4 ケース）
- `TestNotifyComplete_MessageTruncation`: mockNtfyService で空文字・80文字・100文字・150文字の切り詰め動作検証（4 ケース）

### 動作確認フロー

```
1. バックエンドビルド確認
   cd /Users/user/Ghostrunner/backend && go build ./...

2. テスト実行
   cd /Users/user/Ghostrunner/backend && go test ./internal/service/... -v

3. ntfy.sh トピックを作成・購読
   - スマホ: ntfy アプリでトピック名を入力して Subscribe
   - macOS: brew install ntfy && ntfy subscribe <トピック名>
   - ブラウザ: https://ntfy.sh/<トピック名> にアクセス

4. 環境変数を設定してバックエンド起動
   NTFY_TOPIC=<トピック名> make restart-backend-logs
   ログに "[NtfyService] Initialized with topic: https://ntfy.sh/<トピック名>" が表示されることを確認

5. フロントエンドからコマンドを実行
   - 正常完了時: ntfy に "Claude Code - Complete" 通知（Priority: default, Tags: white_check_mark）が届くことを確認
   - エラー発生時: ntfy に "Claude Code - Error" 通知（Priority: high, Tags: x）が届くことを確認

6. NTFY_TOPIC 未設定で起動
   make restart-backend-logs（NTFY_TOPIC なし）
   ログに "[NtfyService] NTFY_TOPIC is not set" が表示され、通知なしで正常動作することを確認
```

### デプロイ後の確認事項

- [ ] Cloud Run の環境変数に `NTFY_TOPIC` を設定
- [ ] デプロイ後にコマンド実行 -> ntfy 通知到達を確認
- [ ] `NTFY_TOPIC` 未設定状態でもサーバーが正常起動することを確認
- [ ] スマホ（iOS/Android）で ntfy アプリに通知が届くことを確認
- [ ] エラー時に priority=high で通知されることを確認（ntfy アプリ上で高優先度表示）
- [ ] フロントエンドの旧通知コード削除（Step 4）を後続フェーズで実施

---

## フロントエンド実装レポート

### 実装サマリー
- **実装日**: 2026-02-16
- **対象フェーズ**: Step 4（フロントエンド側のブラウザ通知コード削除）
- **変更ファイル数**: 2 files（1 削除 + 1 変更）

### 変更ファイル一覧

| ファイル | 操作 | 変更内容 |
|---------|------|---------|
| `frontend/src/hooks/useDesktopNotification.ts` | 削除 | Web Notifications API を使ったブラウザ通知フック全体（31行）を削除。`Notification.requestPermission()` による権限取得、`document.hidden` によるバックグラウンド判定、`new Notification()` によるデスクトップ通知送信の全機能を除去 |
| `frontend/src/app/page.tsx` | 変更 | 6箇所の変更: (1) `useDesktopNotification` の import 文削除、(2) `useDesktopNotification()` フック呼び出し削除、(3) complete イベント内の `desktopNotify("コマンド完了", ...)` 呼び出し削除、(4) `handleStreamEvent` の dependency array から `desktopNotify` 削除、(5) `handleError` 内の `desktopNotify("コマンドエラー", ...)` 呼び出し削除、(6) `handleError` の dependency array から `desktopNotify` 削除。コメントを「通知:」から「音声通知:」に更新し、残存する `useVoiceNotification` フックの役割を明確化 |

### 計画からの変更点

特になし。計画書 Step 4 に記載の通りの6箇所を削除した。

### レビュー結果

| 種別 | 確認項目 | 結果 |
|------|---------|------|
| TypeScript型チェック | `useDesktopNotification` への参照残存 | OK - 参照完全除去済み |
| Next.js ビルド | `npm run build` | OK - エラーなし |
| Critical/Warning | ビルド時の警告 | なし |
| ESLint | 静的解析 | 既存の `useSessionManagement.ts` のエラーのみ（今回の変更とは無関係） |

### 実装時の課題

特になし。計画通りの削除作業で、ブラウザ通知に関するコードは `useDesktopNotification.ts` と `page.tsx` の該当箇所に閉じており、他のコンポーネントへの影響はなかった。

### 残存する懸念点

- **音声通知（`useVoiceNotification`）は引き続きフロントエンドに残存**: ブラウザ通知は削除されたが、OpenAI Realtime API を使った音声通知フックはフロントエンドに残っている。これはバックエンド ntfy.sh 通知とは独立した機能であり、意図的に残している
- **`useDesktopNotification.ts` ファイルの git 追跡**: `git status` で `D` (deleted) 表示だが、まだコミット前の状態。コミット時に `git add` で削除をステージングする必要がある

### 動作確認フロー

```
1. フロントエンドビルド確認
   cd /Users/user/Ghostrunner/frontend && npm run build
   -> ビルドが正常完了すること

2. フロントエンド起動
   make restart-frontend-logs
   -> エラーなく起動すること

3. コマンド実行（正常完了）
   - フロントエンドからコマンドを実行
   - 完了時にブラウザ通知が表示されないことを確認（以前は Notification が出ていた）
   - 音声通知が有効な場合は音声通知のみ動作すること
   - バックエンド側の ntfy.sh 通知が届くことを確認

4. コマンド実行（エラー発生）
   - エラーが発生するコマンドを実行
   - ブラウザ通知が表示されないことを確認
   - バックエンド側の ntfy.sh エラー通知が届くことを確認

5. ブラウザコンソール確認
   - DevTools Console を開いた状態でコマンド実行
   - Notification 関連のエラーや警告が出ないことを確認
```

### デプロイ後の確認事項

- [ ] フロントエンドビルドがCI/CDパイプラインで正常完了すること
- [ ] コマンド完了時にブラウザ通知が出ないことを確認（意図的な削除）
- [ ] 音声通知機能が引き続き正常に動作すること
- [ ] バックエンド ntfy.sh 通知と組み合わせてエンドツーエンドで通知が届くことを確認
