# 調査レポート: ntfy.sh 導入調査

## 概要

ntfy.sh はオープンソース (Apache 2.0 / GPLv2) の HTTP ベース Pub-Sub 通知サービス。シンプルな HTTP PUT/POST でスマホやデスクトップにプッシュ通知を送信できる。公式サーバー (ntfy.sh) の無料利用またはセルフホストが可能。

## 背景

Claude Code などのコマンド完了時にスマホへ通知を送りたいユースケースに対し、ntfy.sh は最も軽量かつ導入が容易な手段である。Go バックエンドから標準ライブラリのみで送信可能な点がプロジェクトと親和性が高い。

---

## 調査結果

### 1. HTTP API 仕様

#### エンドポイント

```
POST https://ntfy.sh/<topic>    -- メッセージ本文を body に
PUT  https://ntfy.sh/<topic>    -- ファイルアップロード時
POST https://ntfy.sh/           -- JSON形式 (トピックをbodyに含む)
```

#### 主要ヘッダー

| ヘッダー | エイリアス | 値の例 | 説明 |
|----------|-----------|--------|------|
| `X-Title` | `Title`, `t`, `ti` | `"Build Complete"` | 通知タイトル |
| `X-Priority` | `Priority`, `p` | `1`-`5` or `min`,`low`,`default`,`high`,`urgent` | 優先度 |
| `X-Tags` | `Tags`, `ta` | `"warning,skull"` | タグ (絵文字マッピングあり) |
| `X-Click` | `Click` | `"https://example.com"` | タップ時のURL |
| `X-Attach` | `Attach`, `a` | `"https://example.com/file.jpg"` | 添付ファイルURL |
| `X-Filename` | `Filename`, `f` | `"report.pdf"` | ファイル名 |
| `X-Delay` | `Delay`, `At`, `In` | `"30m"`, `"tomorrow, 10am"` | 送信遅延 |
| `X-Markdown` | `Markdown`, `md` | `"yes"` | Markdown有効化 |
| `X-Actions` | `Actions` | 後述 | アクションボタン (最大3つ) |
| `X-Icon` | `Icon` | URL | アイコン画像 |

#### 優先度レベル

| レベル | 数値 | 動作 |
|--------|------|------|
| min | 1 | 振動/音なし、折りたたみ内 |
| low | 2 | 振動/音なし |
| default | 3 | 短い振動 |
| high | 4 | 長い振動、ポップオーバー表示 |
| urgent | 5 | 長い振動バースト、ポップオーバー表示 |

#### JSON形式での送信

```json
{
  "topic": "mytopic",
  "title": "Alert",
  "message": "Something happened",
  "priority": 4,
  "tags": ["warning"],
  "click": "https://example.com",
  "actions": [
    {
      "action": "view",
      "label": "Open",
      "url": "https://example.com"
    }
  ]
}
```

#### 認証

```
Authorization: Basic <base64(user:password)>
Authorization: Bearer <token>
?auth=<token>  (クエリパラメータ)
```

#### 制約

- メッセージサイズ: 最大 4,096 バイト
- アクションボタン: 最大 3 つ
- 遅延: 最小 10 秒、最大 3 日

---

### 2. セルフホスト vs 公式サーバー

| 項目 | 公式サーバー (ntfy.sh) | セルフホスト |
|------|----------------------|-------------|
| セットアップ | 不要 (即利用可) | サーバー構築が必要 |
| 料金 | 無料 (制限あり) / 有料プラン | 無料 (自前インフラ費用のみ) |
| レート制限 | あり (後述) | 自由に設定可能/無制限化可 |
| データプライバシー | ログにトピック名・IPが含まれる | 完全に自分で管理 |
| iOS通知 | FCM経由で省電力 | poll_requestをntfy.shに転送する必要あり |
| Android バッテリー | FCM利用時: 追加消費なし | 常時接続: 17時間で0-1%程度 |
| アップタイム | 高い実績あり | 自己管理 |

**結論**: 用途が「コマンド完了通知」程度であれば公式サーバーの無料プランで十分。機密情報を含む場合のみセルフホストを検討。

---

### 3. トピック名のセキュリティ

**重要: トピック名がパスワードの役割を果たす。**

- 公式サーバーのデフォルトでは、トピック名を知っている人は誰でも購読・送信が可能
- 推測しやすいトピック名 (例: `test`, `alerts`) は他人に読まれるリスクがある
- ブルートフォースはレート制限により実質不可能
- セルフホスト時はACL (アクセス制御リスト) で認証を設定可能

#### 推奨対策

1. **トピック名を十分にランダムにする** (例: `ghostrunner-notify-a8f3k2x9`)
2. セルフホスト時は `auth-default-access: deny-all` に設定し、ユーザー認証を必須にする
3. 有料プランでトピック名を予約する (他者の使用をブロック)

#### セルフホスト時のACL設定例

```bash
# ユーザー追加
ntfy user add myuser

# トピックのアクセス権設定
ntfy access myuser "ghostrunner-*" read-write
ntfy access "*" "ghostrunner-*" deny
```

---

### 4. モバイルアプリ

#### iOS

- **App Store** で「ntfy」で検索してインストール可能
- FCM (Firebase Cloud Messaging) 経由で通知を受信
- セルフホストサーバー利用時は、設定画面でサーバーURLとユーザー名/パスワードを設定
- **制限事項**: iOS版はやや機能が限定的 (開発者がiOS開発に苦戦した経緯あり)
- セルフホスト時は `poll_request` を ntfy.sh 公式サーバーに転送する設定が必要

#### Android

- **Google Play** または **F-Droid** からインストール可能
- F-Droid版はFirebaseを使用しない (プライバシー重視)
- Instant Delivery機能: 常時接続で即時通知 (Dozeモードでも受信可能)
- 通知チャンネルを優先度ごとにカスタマイズ可能
- カスタムサーバー設定: Settings → Advanced → Custom headers

#### アプリ設定手順

1. アプリを開く
2. トピック名を入力して「Subscribe」
3. (セルフホスト時) 設定からサーバーURLを変更

---

### 5. macOS での受信方法

#### 方法1: ntfy CLI

```bash
# インストール (tarballをダウンロードしてPATHに配置)
# https://docs.ntfy.sh/install/ を参照

# 単発購読 (JSONストリーム)
ntfy subscribe mytopic

# コマンド実行付き購読
ntfy subscribe mytopic 'osascript -e "display notification \"$message\" with title \"$title\""'
```

設定ファイル: `~/Library/Application Support/ntfy/client.yml`

```yaml
default-host: https://ntfy.sh
subscribe:
  - topic: ghostrunner-notify
    command: 'osascript -e "display notification \"$message\" with title \"ntfy: $title\""'
```

起動: `ntfy subscribe --from-config`

#### 方法2: ntfy-desktop (Electron アプリ)

- GitHub: https://github.com/Aetherinox/ntfy-desktop
- Windows / Linux / macOS 対応
- GUIで購読管理、デスクトップ通知表示

#### 方法3: curlでポーリング

```bash
# シンプルなSSE購読
curl -s "https://ntfy.sh/mytopic/sse" | while read line; do
  echo "$line"
done
```

---

### 6. Go言語からの送信コード例

#### 最小限の送信

```go
package main

import (
    "net/http"
    "strings"
)

func main() {
    http.Post(
        "https://ntfy.sh/mytopic",
        "text/plain",
        strings.NewReader("Backup successful"),
    )
}
```

#### ヘッダー付き送信 (タイトル、優先度、タグ)

```go
func sendNotification(topic, title, message string, priority int) error {
    req, err := http.NewRequest(
        "POST",
        "https://ntfy.sh/"+topic,
        strings.NewReader(message),
    )
    if err != nil {
        return fmt.Errorf("failed to create request: %w", err)
    }

    req.Header.Set("Title", title)
    req.Header.Set("Priority", strconv.Itoa(priority))
    req.Header.Set("Tags", "white_check_mark")

    resp, err := http.DefaultClient.Do(req)
    if err != nil {
        return fmt.Errorf("failed to send notification: %w", err)
    }
    defer resp.Body.Close()

    if resp.StatusCode != http.StatusOK {
        return fmt.Errorf("unexpected status code: %d", resp.StatusCode)
    }
    return nil
}
```

#### JSON形式での送信

```go
func sendJSONNotification(topic, title, message string) error {
    payload := map[string]interface{}{
        "topic":    topic,
        "title":    title,
        "message":  message,
        "priority": 3,
        "tags":     []string{"white_check_mark"},
    }

    body, err := json.Marshal(payload)
    if err != nil {
        return fmt.Errorf("failed to marshal payload: %w", err)
    }

    resp, err := http.Post(
        "https://ntfy.sh/",
        "application/json",
        bytes.NewReader(body),
    )
    if err != nil {
        return fmt.Errorf("failed to send notification: %w", err)
    }
    defer resp.Body.Close()
    return nil
}
```

**注意**: 外部ライブラリ不要。Go標準ライブラリ (`net/http`, `encoding/json`) のみで実装可能。

---

### 7. 無料プランの制限

#### 公式サーバー (ntfy.sh) の無料プラン

| 項目 | 無料 | Supporter ($5/月) | Pro ($10/月) | Business ($20/月) |
|------|------|-------------------|-------------|-------------------|
| 日次メッセージ | 250 | 2,500 | 20,000 | 50,000 |
| 添付ファイルサイズ | 2 MB | 25 MB | 250 MB | 1 GB |
| 日次メール | 5 | 50 | 250 | 500 |
| 予約トピック | 0 | 3 | 10 | 50 |
| 電話通知 | 0 | 3 | 20 | 50 |

#### レート制限

- バースト: 60リクエスト (一度に送信可能)
- 補充レート: 10秒に1リクエスト
- 全バースト容量の回復: 約10分

#### 無料プランの評価

「コマンド完了通知」の用途では1日250メッセージは十分すぎる。通常の開発作業では1日数十回程度の通知が想定されるため、無料プランで問題なし。

---

## 結論・推奨

### 推奨構成

1. **公式サーバー (ntfy.sh) の無料プランを使用** -- セットアップ不要で即利用可能
2. **トピック名はランダムな文字列にする** -- 例: `ghostrunner-notify-<ランダム文字列>`
3. **Go バックエンドから標準ライブラリで送信** -- 外部依存なし
4. **スマホは iOS/Android アプリで受信** -- App Store / Google Play からインストール
5. **macOS は ntfy CLI + osascript で受信** -- ネイティブ通知として表示

### 実装の簡単さ

Go から ntfy.sh への通知送信は `http.Post()` 1行で完了する。サーバー側の実装コストは極めて低い。トピック名を環境変数で管理すれば、セキュリティも担保できる。

---

## ソース一覧

- [Sending messages - ntfy (公式ドキュメント)](https://docs.ntfy.sh/publish/) - HTTP API仕様、ヘッダー、Go コード例
- [FAQs - ntfy](https://docs.ntfy.sh/faq/) - セルフホスト vs 公式、セキュリティFAQ
- [Configuration - ntfy](https://docs.ntfy.sh/config/) - ACL設定、レート制限、ユーザー管理
- [From the CLI - ntfy](https://docs.ntfy.sh/subscribe/cli/) - CLI購読、macOS設定
- [From your phone - ntfy](https://docs.ntfy.sh/subscribe/phone/) - iOS/Androidアプリ設定
- [ntfy App - App Store](https://apps.apple.com/us/app/ntfy/id1625396347) - iOSアプリ
- [ntfy.sh ホームページ](https://ntfy.sh/) - 料金プラン
- [ntfy-desktop (GitHub)](https://github.com/Aetherinox/ntfy-desktop) - macOS Electronクライアント
- [GitHub Issue #1167](https://github.com/binwiederhier/ntfy/issues/1167) - 無料プラン制限の詳細
- [Installation - ntfy](https://docs.ntfy.sh/install/) - インストール手順

## 関連資料

- このレポートを参照: /discuss, /plan で活用
