# ntfy.sh 通知導入

## 背景

- macOSのブラウザ通知（Web Notifications API）が動作しなくなった
- ブラウザの権限管理が厳しく、不安定
- スマホ（iOS/Android）でも通知を受けたい

## 現在の実装

フロントエンド側でブラウザのWeb Notifications APIを使用:
- `useDesktopNotification.ts` フック
- コマンド完了時・エラー時に `desktopNotify()` を呼び出し
- タブがバックグラウンドの時のみ通知
- ブラウザの許可設定に完全依存 → 不安定

## 方針: ntfy.sh に移行

### ntfy.sh とは

軽量なHTTP通知サービス。HTTP POSTするだけでスマホ・PCに通知が届く。

### 変更内容

#### バックエンド（Go）

1. **ntfy通知サービスを追加**
   - `internal/infrastructure/ntfy/` にntfy送信クライアントを作成
   - Go標準ライブラリのみで実装（`net/http`）
   - 送信例: `http.Post("https://ntfy.sh/<topic>", "text/plain", body)`

2. **complete/errorイベント送信時にntfy通知を追加**
   - `claude.go` のcomplete送信箇所（267行目、401行目付近）
   - 各エラー送信箇所
   - SSEイベント送信と並行してntfyへPOST

3. **環境変数で設定管理**
   - `NTFY_TOPIC`: トピック名（推測不能なランダム文字列）
   - `NTFY_SERVER`: サーバーURL（デフォルト: `https://ntfy.sh`）
   - トピック未設定時は通知をスキップ（オプショナル機能）

#### フロントエンド（Next.js）

1. **`useDesktopNotification.ts` を削除**
2. **`page.tsx` から `desktopNotify` 呼び出しを削除**

### 受信側のセットアップ

#### スマホ（iOS / Android）

1. ntfyアプリをインストール（App Store / Google Play）
2. トピック名を入力して「Subscribe」

#### macOS

1. `brew install ntfy` でCLIをインストール
2. `ntfy subscribe <topic>` で受信開始
3. macOSネイティブ通知として表示

### トピック名のセキュリティ

- 公式サーバーではトピック名 = パスワード
- 十分にランダムな文字列を使用（例: `ghostrunner-notify-a8f3k2x9`）
- 環境変数で管理、コードにハードコードしない

### 無料プランの制限

| 項目 | 制限 |
|------|------|
| 日次メッセージ | 250 |
| バースト制限 | 60リクエスト |

コマンド完了通知の用途なら十分。

## 次のステップ

`/plan` で実装計画を作成 → 実装
