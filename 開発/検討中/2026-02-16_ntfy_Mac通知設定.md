# 検討結果: ntfy.sh Mac PC 通知設定

## 検討経緯

| 日付 | 内容 |
|------|------|
| 2026-02-16 | 初回相談: ntfy.sh の Mac PC 受信側が未設定で通知が届かない問題 |
| 2026-02-16 | 方針決定: ntfy CLI + LaunchAgent 方式を採用、`make setup-ntfy` で自動セットアップ |

## 背景・目的

ntfy.sh 通知機能のバックエンド（送信側）は実装済みだが、Mac PC 側の受信設定が未完了のため通知が届かない。`make` コマンド一発で受信環境をセットアップできるようにする。

## 現状

- バックエンド: `https://ntfy.sh/{NTFY_TOPIC}` へのHTTP POST送信 → 完成
- 環境変数 `NTFY_TOPIC=ghostrunner-42e0a0e9` → 設定済み
- ntfy CLI: `/opt/homebrew/bin/ntfy` (v2.17.0) → インストール済み
- Mac PC の受信側: **未設定**（ntfy プロセスが起動していない、設定ファイルも未作成）

## 対象ユーザー

Ghostrunner を Mac で運用する開発者・運用者

## 解決する課題

バックエンドからの ntfy.sh 通知が Mac PC に届かない。受信プロセスの起動や設定ファイルの作成を手動で行うのは手間がかかり、Mac 再起動後に忘れる可能性もある。LaunchAgent による自動起動で確実に通知を受け取れるようにする。

## 選択肢の検討

### 案A: ntfy CLI + LaunchAgent（採用）

- 概要: ntfy CLI の subscribe コマンドを LaunchAgent で常駐させ、osascript / terminal-notifier でネイティブ通知を表示
- メリット: ブラウザ不要、Mac 起動時に自動起動、ターミナルを閉じても動作継続、osascript はデフォルトで通知許可されていることが多い
- デメリット: LaunchAgent の管理が必要、plist ファイルの作成が必要
- 工数感: 小

### 案B: ブラウザで ntfy.sh Web UI を開く

- 概要: `https://ntfy.sh/{TOPIC}` をブラウザで開き、ブラウザのプッシュ通知を利用
- メリット: 追加インストール不要、設定が簡単
- デメリット: ブラウザの通知許可が必要（元の Web Notifications API と同じ問題）、ブラウザを閉じると通知が届かない
- 工数感: 小

### 案C: ntfy デスクトップアプリ

- 概要: ntfy の公式デスクトップアプリ（Electron ベース）を使用
- メリット: GUI で設定可能、公式サポート
- デメリット: 別途アプリのインストールが必要、Electron アプリが常駐するリソース消費、自動化しにくい
- 工数感: 小

## MVP提案

**推奨案**: 案A（ntfy CLI + LaunchAgent）

### MVP範囲

以下の 3 つの Make ターゲットを実装する。

#### 1. `make setup-ntfy` が行うこと

1. **ntfy CLI のインストール確認**
   - `which ntfy` でインストール済みか確認
   - 未インストールの場合はエラーメッセージを表示して終了（`brew install ntfy` を案内）

2. **NTFY_TOPIC の読み取り**
   - `backend/.env` から `NTFY_TOPIC` を読み取る
   - 未設定の場合はエラーメッセージを表示して終了

3. **ntfy クライアント設定ファイルの作成**
   - パス: `~/Library/Application Support/ntfy/client.yml`
   - 内容:
     ```yaml
     default-host: https://ntfy.sh
     subscribe:
       - topic: {NTFY_TOPIC}
         command: 'terminal-notifier -title "$NTFY_TITLE" -message "$NTFY_MESSAGE" -group ntfy 2>/dev/null || osascript -e "display notification \"$NTFY_MESSAGE\" with title \"$NTFY_TITLE\""'
     ```
   - terminal-notifier があればそちらを優先（より高機能）、なければ osascript にフォールバック

4. **LaunchAgent plist ファイルの作成**
   - パス: `~/Library/LaunchAgents/sh.ntfy.subscriber.plist`
   - 内容:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
       "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
     <plist version="1.0">
     <dict>
       <key>Label</key>
       <string>sh.ntfy.subscriber</string>
       <key>ProgramArguments</key>
       <array>
         <string>/opt/homebrew/bin/ntfy</string>
         <string>subscribe</string>
         <string>--from-config</string>
       </array>
       <key>RunAtLoad</key>
       <true/>
       <key>KeepAlive</key>
       <true/>
       <key>StandardOutPath</key>
       <string>/tmp/ntfy-subscriber.log</string>
       <key>StandardErrorPath</key>
       <string>/tmp/ntfy-subscriber.log</string>
     </dict>
     </plist>
     ```

5. **LaunchAgent の登録と起動**
   ```bash
   launchctl unload ~/Library/LaunchAgents/sh.ntfy.subscriber.plist 2>/dev/null
   launchctl load ~/Library/LaunchAgents/sh.ntfy.subscriber.plist
   ```

6. **テスト通知の送信**
   - セットアップ完了後、テスト通知を送信して動作確認
     ```bash
     curl -s -d "ntfy setup complete" -H "Title: Ghostrunner" https://ntfy.sh/{NTFY_TOPIC}
     ```
   - 「通知が届いたか確認してください」とメッセージ表示

#### 2. `make uninstall-ntfy`

- LaunchAgent の停止と削除
- 設定ファイルの削除
- ntfy CLI 自体はアンインストールしない（brew 管理のため）

#### 3. `make status-ntfy`

- LaunchAgent の状態確認
- ntfy プロセスの確認
- 設定ファイルの存在確認
- 最新のログ表示

### 通知許可について

- **osascript 方式**: macOS では「スクリプトエディタ」からの通知はデフォルトで許可されていることが多い。許可されていない場合は「システム設定 > 通知 > スクリプトエディタ」で通知を有効にする
- **terminal-notifier 方式**: 初回実行時に macOS が通知許可を求めるダイアログを表示する。許可すれば以降は自動的に通知される
- **いずれの場合も**: `make setup-ntfy` 実行後のテスト通知で動作確認できる。通知が届かない場合のトラブルシューティング手順もスクリプト内に含める

### 次回以降

- 通知のカスタマイズ（サウンド変更、通知グループ化など）
- 複数トピックの購読対応
- 通知フィルタリング（重要度に応じた通知制御）

## 変更ファイル一覧

| ファイル | 操作 | 概要 |
|----------|------|------|
| `Makefile` | 変更 | `setup-ntfy`, `uninstall-ntfy`, `status-ntfy` ターゲットを追加 |
| `scripts/setup-ntfy.sh` | 新規 | セットアップスクリプト本体 |
| `scripts/uninstall-ntfy.sh` | 新規 | アンインストールスクリプト |

## テスト手順

1. `make setup-ntfy` を実行
2. テスト通知が Mac の通知センターに表示されることを確認
3. `make status-ntfy` で状態確認
4. フロントエンドからコマンドを実行し、完了通知が届くことを確認
5. Mac を再起動後、再度コマンド実行して通知が届くことを確認（LaunchAgent 自動起動の検証）
6. `make uninstall-ntfy` でクリーンアップできることを確認

## 次のステップ

1. この検討結果を `開発/検討中/` に保存 → 完了
2. 方針決定後、`/plan` で実装計画を作成
3. 計画確定後、`開発/実装/実装待ち/` に移動
